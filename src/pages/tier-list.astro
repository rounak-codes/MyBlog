---
import { tierListInfo } from "../data/tierListInfo";
import { characters } from "../data/tierlist";
import MainGridLayout from "../layouts/WideLayout.astro";
import fs from 'node:fs';
import path from 'node:path';

const dataFilePath = path.join(process.cwd(), 'src/data/tierlist.ts');
let lastUpdated = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
try {
  if (fs.existsSync(dataFilePath)) {
    const stats = fs.statSync(dataFilePath);
    // Format the date (e.g., "October 5, 2025")
    lastUpdated = stats.mtime.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric' 
    });
  }
} catch (e) {
  console.warn('Could not fetch tier list update time:', e);
}

// --- DATA & ICONS ---
const icons = {
	pyro: "/assets/icons/pyro.png",
	hydro: "/assets/icons/hydro.png",
	anemo: "/assets/icons/anemo.png",
	electro: "/assets/icons/electro.png",
	dendro: "/assets/icons/dendro.png",
	cryo: "/assets/icons/cryo.png",
	geo: "/assets/icons/geo.png",
	sword: "/assets/icons/sword.png",
	claymore: "/assets/icons/claymore.png",
	polearm: "/assets/icons/polearm.png",
	catalyst: "/assets/icons/catalyst.png",
	bow: "/assets/icons/bow.png",
	wildcard: "/assets/icons/star.png",
	rarity4: "/assets/icons/4star.png",
	rarity5: "/assets/icons/5star.png",
	close: "/assets/icons/close.png",
};

const filterData = {
	rarity: [
		{ id: "all", label: "∗", color: "text-blue-400" },
		{ id: "4", label: "4★", color: "text-purple-400" },
		{ id: "5", label: "5★", color: "text-yellow-400" },
	],
	elements: [
		{ id: "all" },
		{ id: "pyro", icon: icons.pyro },
		{ id: "hydro", icon: icons.hydro },
		{ id: "anemo", icon: icons.anemo },
		{ id: "electro", icon: icons.electro },
		{ id: "dendro", icon: icons.dendro },
		{ id: "cryo", icon: icons.cryo },
		{ id: "geo", icon: icons.geo },
	],
	weapons: [
		{ id: "all" },
		{ id: "sword", icon: icons.sword },
		{ id: "claymore", icon: icons.claymore },
		{ id: "polearm", icon: icons.polearm },
		{ id: "catalyst", icon: icons.catalyst },
		{ id: "bow", icon: icons.bow },
	],
};

const tierColors = {
    T0: "border-red-600/50 bg-red-600/10 text-red-600",          // Deep Red
    "T0.5": "border-red-400/50 bg-red-400/10 text-red-400",       // Lighter Red
    T1: "border-orange-500/50 bg-orange-500/10 text-orange-500",  // Orange
    "T1.5": "border-amber-500/50 bg-amber-500/10 text-amber-500", // Lighter Orange (Amber)
    T2: "border-yellow-400/50 bg-yellow-400/10 text-yellow-400",  // Paler Fade of Orange (Yellowish)
    T3: "border-lime-500/50 bg-lime-500/10 text-lime-500",        // Pale Green
    T4: "border-green-600/50 bg-green-600/10 text-green-600",     // Darker Green
    T5: "border-cyan-500/50 bg-cyan-500/10 text-cyan-500",        // Cyan
};
---

<MainGridLayout title="Tier List">
  
<!-- HEADER INFO -->
<div class="max-w-7xl mx-auto mb-6">
  <div class="card-base p-6 mb-4 flex flex-col items-center text-center">
      <h1 class="text-3xl md:text-4xl font-bold text-90 mb-2">Xiffy's Tier List</h1>
      <div class="flex items-center gap-2 text-50 text-sm">
          <span>Patch: 6.3</span><span class="w-1 h-1 bg-current rounded-full"></span><span>Updated: {lastUpdated}</span>
      </div>
  </div>
  <div class="card-base flex flex-col">
    {tierListInfo.map((item) => (
      <details class="group border-b border-[var(--line-divider)] border-dashed last:border-none">
        <summary class="flex justify-between items-center p-4 font-medium text-75 hover:text-[var(--primary)] hover:bg-[var(--btn-plain-bg-hover)] transition select-none list-none cursor-pointer">
          {item.title}
          <span class="transform group-open:rotate-180 transition-transform duration-200 text-50">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6l-6-6z"/></svg>
          </span>
        </summary>
        <div class="px-4 pb-4 text-sm text-50 pt-2" set:html={item.content} />
      </details>
    ))}
  </div>
</div>

<!-- MODE SWITCHER -->
<div class="max-w-7xl mx-auto grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
  {['overworld', 'abyss', 'theatre', 'stygian'].map((mode) => (
    <button class="mode-btn relative p-3 card-base hover:bg-[var(--btn-card-bg-hover)] group transition-all border border-transparent" data-mode={mode}>
      <div class="text-xs uppercase tracking-wider text-50 mb-1">Game Mode</div>
      <div class="text-lg font-bold capitalize text-75 group-[.active]:text-[var(--primary)]">{mode}</div>
      <div class="active-indicator absolute bottom-0 left-0 w-full h-0.5 bg-[var(--primary)] scale-x-0 group-[.active]:scale-x-100 transition-transform duration-300 origin-left"></div>
    </button>
  ))}
</div>

<!-- FILTER TOOLBAR -->
<div class="max-w-7xl mx-auto mb-6 sticky top-[4.5rem] z-20">
  <div class="card-base p-2 flex flex-wrap lg:flex-nowrap items-center gap-2 bg-[var(--card-bg)] shadow-lg border border-[var(--line-divider)]">
      
      <div class="relative order-1 lg:order-none flex-grow lg:flex-1 lg:min-w-[140px] lg:max-w-[20rem] group shrink-0 lg:mx-2">
          <input type="text" id="searchInput" placeholder="Search..." class="w-full bg-[var(--btn-regular-bg)] text-90 rounded-md pl-4 pr-8 py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-[var(--primary)] transition placeholder:text-50" />
          <button id="clearSearch" class="absolute right-2 top-1/2 -translate-y-1/2 text-50 hover:text-90 opacity-0 group-focus-within:opacity-100 has-value:opacity-100 transition">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
          </button>
      </div>

      <div class="h-5 w-px bg-[var(--line-divider)] hidden lg:block mx-1 shrink-0"></div>

      <div class="order-3 lg:mx-2 lg:order-none w-full lg:w-auto flex flex-wrap lg:flex-nowrap gap-2 items-center justify-center lg:justify-start pb-1 lg:pb-0 mt-2 lg:mt-0 border-t lg:border-t-0 border-[var(--line-divider)] border-dashed pt-2 lg:pt-0">
          
          <div class="filter-group flex bg-[var(--btn-regular-bg)] rounded-md p-1 shrink-0" data-group="rarity">
              {filterData.rarity.map(item => (
                   <button class={`filter-btn relative px-3 py-1 rounded-sm text-sm font-bold transition hover:bg-[var(--btn-plain-bg-hover)] [data-active=true]:bg-[var(--primary)] [data-active=true]:text-white flex items-center justify-center ${item.color}`} 
                          data-value={item.id} 
                          title={item.id === 'all' ? 'All Rarities' : item.id + ' Star'}>
                      <span class={item.id === 'all' ? 'text-xl leading-none font-bold' : ''}>{item.label}</span>
                  </button>
              ))}
          </div>

          <div class="filter-group lg:ml-2 flex bg-[var(--btn-regular-bg)] rounded-md p-0.5 shrink-0" data-group="element">
              {filterData.elements.map(item => (
                  <button class="filter-btn w-8 h-8 rounded-sm text-50 hover:text-90 hover:bg-[var(--btn-plain-bg-hover)] transition [data-active=true]:bg-[var(--primary)] [data-active=true]:text-white flex items-center justify-center" data-value={item.id} title={item.id}>
                      {item.id === 'all' ? (
                            <span class="text-3xl font-bold leading-none mb-1">∗</span>
                        ) : (
                            <div class="w-5 h-5 flex items-center justify-center bg-black/30 rounded-full">
                                <img src={item.icon} alt={item.id} class="w-3.5 h-3.5 object-contain" />
                            </div>
                        )}
                    </button>
                ))}
          </div>

          <div class="filter-group lg:ml-2 flex bg-[var(--btn-regular-bg)] rounded-md p-0.5 shrink-0" data-group="weapon">
            {filterData.weapons.map(item => (
                <button class="filter-btn w-8 h-8 rounded-sm text-50 hover:text-90 hover:bg-[var(--btn-plain-bg-hover)] transition [data-active=true]:bg-[var(--primary)] [data-active=true]:text-white flex items-center justify-center" data-value={item.id} title={item.id}>
                    {item.id === 'all' ? (
                        <span class="text-3xl font-bold leading-none mb-1">∗</span>
                    ) : (
                        <img src={item.icon} alt={item.id} class="w-5 h-5 object-contain brightness-0 dark:invert" />
                    )}
                </button>
            ))}
        </div>
      </div>

      <div class="h-5 lg:ml-2 w-px bg-[var(--line-divider)] hidden lg:block mx-1 shrink-0"></div>

      <button id="resetFilters" class="order-2 lg:order-last px-3 py-2 rounded-md text-sm font-medium text-50 hover:text-red-400 hover:bg-[var(--btn-regular-bg-hover)] transition flex items-center gap-1.5 shrink-0 border-l border-[var(--line-divider)] lg:border-none pl-3 lg:pl-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> 
          <span>Reset</span>
      </button>

  </div>
</div>

<!-- TABLE HEADER -->
<div class="max-w-7xl mx-auto hidden md:grid grid-cols-[6rem_1fr_1fr_1fr] gap-0 px-0 mb-2">
  <div class="flex items-center justify-center font-black text-white/60 text-l tracking-widest select-none">
    v6.3
  </div>
  
  <!-- MAIN DPS (Sword Icon) -->
  <div class="bg-[var(--card-bg)]/50 py-2 text-center border-b-2 border-red-500/50 flex items-center justify-center gap-2">
     <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="text-red-400"><path fill="currentColor" d="M14.5 17.5L3 6V3h3l11.5 11.5c.83.83.83 2.17 0 3s-2.17.83-3 0zm5.66-3.66l-2.83-2.83-1.41 1.41 2.83 2.83 1.41-1.41zM20.71 5.63l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-3.12 3.12-1.93-1.91-1.41 1.41 1.42 1.42L3 16.25V21h4.75l8.92-8.92 1.42 1.42 1.41-1.41-1.92-1.92 3.12-3.12c.4-.4.4-1.03.01-1.42z"/></svg>
     <span class="font-bold text-red-400 text-sm tracking-wider">MAIN DPS</span>
  </div>

  <!-- SUB DPS (Borg/Robot Icon) -->
  <div class="bg-[var(--card-bg)]/50 py-2 text-center border-b-2 border-purple-500/50 flex items-center justify-center gap-2 text-purple-400">
    <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px">
      <path fill="currentColor" d="M480-80q-11 0-21-3t-19-8L160-252q-19-11-29.5-29.5T120-322v-316q0-22 10.5-40.5T160-708l280-161q9-5 19-8t21-3q11 0 21 3t19 8l280 161q19 11 29.5 29.5T840-638v316q0 22-10.5 40.5T800-252L520-91q-9 5-19 8t-21 3ZM320-320v-120H200v118l240 139v-137H320Zm0-320h120v-137L200-638v118h120v-120Zm80 240h160v-160H400v160Zm240 80H520v137l240-139v-118H640v120Zm0-320v120h120v-118L520-777v137h120Z"/>
    </svg>

    <span class="font-bold text-purple-400 text-sm tracking-wider">SUB DPS</span>
  </div>


  <!-- SUPPORT (Potion/Lab Flask Icon) -->
  <div class="bg-[var(--card-bg)]/50 py-2 text-center border-b-2 border-emerald-500/50 flex items-center justify-center gap-2">
     <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" class="text-emerald-400"><path fill="currentColor" d="M19.66 17.67L15 9.5V4h1V2H8v2h1v5.5l-4.66 8.17C3.76 18.8 4.58 20 5.89 20h12.22c1.31 0 2.13-1.2 1.55-2.33zM7 18l3.5-6H14l3.5 6H7z"/></svg>
     <span class="font-bold text-emerald-400 text-sm tracking-wider">SUPPORT</span>
  </div>
</div>

<!-- HIDDEN DATA BRIDGE -->
<div id="tierListData" 
     data-characters={JSON.stringify(characters)} 
     data-colors={JSON.stringify(tierColors)} 
     class="hidden">
</div>

<!-- TIER LIST CONTAINER -->
<div id="tierListContainer" class="max-w-7xl mx-auto flex flex-col gap-3 min-h-[50vh]"></div>
<script>
  const dataEl = document.getElementById('tierListData');
  // Using simple checks for safety without '!' because this is strict TS
  if (!dataEl) throw new Error("Tier List Data Missing");

  const characters = JSON.parse(dataEl.dataset.characters || '[]');
  const tierColors = JSON.parse(dataEl.dataset.colors || '{}');

  // --- STATE ---
  let currentMode = 'abyss';
  // Explicitly typing this as 'any' helps avoid index errors in strict mode for dynamic keys
  let filters: any = { element: 'all', weapon: 'all', rarity: 'all', search: '' };

  // --- DOM ---
  const container = document.getElementById('tierListContainer');
  const modeBtns = document.querySelectorAll('.mode-btn');
  const searchInput = document.getElementById('searchInput') as HTMLInputElement;
  const clearSearchBtn = document.getElementById('clearSearch');
  const filterBtns = document.querySelectorAll('.filter-btn');
  const resetBtn = document.getElementById('resetFilters');

  // --- HELPERS ---
  // Defined as Record<string, string> so TS knows any string key is valid
  const elementIcons: Record<string, string> = {
      'pyro': '/assets/icons/pyro.png',
      'hydro': '/assets/icons/hydro.png',
      'anemo': '/assets/icons/anemo.png',
      'electro': '/assets/icons/electro.png',
      'dendro': '/assets/icons/dendro.png',
      'cryo': '/assets/icons/cryo.png',
      'geo': '/assets/icons/geo.png'
  };
  
  const weaponIcons: Record<string, string> = {
      'sword': '/assets/icons/sword.png',
      'claymore': '/assets/icons/claymore.png',
      'polearm': '/assets/icons/polearm.png',
      'catalyst': '/assets/icons/catalyst.png',
      'bow': '/assets/icons/bow.png'
  };

  function getTagColor(tag: string) {
      const t = tag.toUpperCase();
      if (t.includes('ULT') || t.includes('PARTNER')) return 'text-red-400';
      if (t.includes('BUFF') || t.includes('SHIELD') || t.includes('CC') || t.includes('DEBUFF') || t.includes('HEAL')) return 'text-green-400';
      if (t.includes('AOE') || t.includes('CLEAVE') || t.includes('ST')) return 'text-white';
      if (t.includes('C0') || t.includes('INVEST')) return 'text-orange-400';
      return 'text-gray-300';
  }

  function getRankColorClass(rank: string) {
    if (!rank) return 'bg-gray-700';
    if (rank === 'T0') return 'bg-red-600 text-white';
    if (rank === 'T0.5') return 'bg-red-400 text-white';
    if (rank === 'T1') return 'bg-orange-500 text-white';
    if (rank === 'T1.5') return 'bg-amber-500 text-white'; // New Tier
    if (rank === 'T2') return 'bg-yellow-400 text-black';
    if (rank === 'T3') return 'bg-lime-500 text-black';
    if (rank === 'T4') return 'bg-green-600 text-white';
    if (rank === 'T5') return 'bg-cyan-500 text-white';
    return 'bg-gray-700 text-gray-300';
}   

  // --- CARD CREATION WITH PRYDWEN HOVER ---
  // Using char: any to bypass strict type checks on dynamic data object
  function createCharCard(char: any) {
      const cons = char.constellation !== undefined ? char.constellation : (char.rarity === 5 ? 0 : 6);
      let bgImage = '/assets/backgrounds/4star-bg.png';
      if (char.id === 'aloy') bgImage = '/assets/backgrounds/aloy-bg.png';
      else if (char.rarity === 5) bgImage = '/assets/backgrounds/5star-bg.png';

      const tagsHtml = char.tags ? char.tags.map((tag: string, i: number) => {
             const suffix = i < char.tags.length - 1 ? ',' : '';
             return `<span class="${getTagColor(tag)} drop-shadow-sm font-bold">${tag}${suffix}</span>`;
        }).join(' ') : '';

      return `
          <div class="relative group w-[80px] flex flex-col items-center z-0 hover:z-50">
            
            <!-- CARD -->
            <div class="relative w-[80px] h-[80px] rounded-md overflow-hidden shadow-md mb-1 bg-cover bg-center cursor-pointer" 
                 style="background-image: url('${bgImage}');"
                 title="${char.name}">
                <img src="${char.image}" class="w-full h-full object-cover p-[1px]" alt="${char.name}" onerror="this.style.opacity='0.2'"/>
                <div class="absolute top-0.5 left-0.5 w-5 h-5 bg-black/50 rounded-full p-0.5 backdrop-blur-sm z-10">
                    <img src="${elementIcons[char.element]}" class="w-full h-full object-contain" />
                </div>
                <div class="absolute top-0 right-0 bg-[#eab308] text-black text-[9px] font-bold px-1 py-0.5 rounded-bl-md leading-none shadow-sm z-10">C${cons}</div>
                <div class="absolute bottom-0 left-0 w-full pt-5 pb-1 px-0.5 bg-gradient-to-t from-black/90 via-black/50 to-transparent z-20 flex items-end justify-center">
                    <span class="text-[9px] text-white font-bold text-center leading-none truncate w-full drop-shadow-md">${char.name}</span>
                </div>
            </div>

            <!-- NEW: TAGS BELOW CARD -->
            <div class="text-[9px] uppercase text-center leading-3 flex flex-wrap justify-center gap-x-1 w-[90px] mt-0.5">
                ${tagsHtml}
            </div>

            <!-- PRYDWEN HOVER POPUP -->
            <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-64 bg-[var(--card-bg)] border border-[var(--line-divider)] border-gray-700 rounded-lg shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50">
                
                <!-- Header: Name & Basic Info -->
                <div class="p-3 border-b border-gray-700 flex gap-3">
                    <!-- Rarity Background Wrapper -->
                  <div class="w-12 h-12 rounded-md overflow-hidden bg-cover bg-center shrink-0 border border-white/10" style="background-image: url('${bgImage}');">
                      <img src="${char.image}" class="w-full h-full object-cover" />
                  </div>
                    <div class="flex flex-col justify-center">
                        <div class="text-[var(--primary)] font-bold text-lg leading-tight text-left">${char.name}</div>
                        <div class="flex items-center gap-2 mt-1">
                            <!-- Rarity Badge -->
                            <span class="text-xs px-1.5 py-0.5 rounded bg-gray-700 text-yellow-400 font-bold shadow-sm">${char.rarity}★</span>
                            
                            <!-- Element Icon (New Gradient Background) -->
                            <div class="w-5 h-5 rounded-full flex items-center justify-center bg-gradient-to-br from-black/60 to-black/30 shadow-sm border border-white/10">
                                <img src="${elementIcons[char.element]}" class="w-3.5 h-3.5 object-contain" />
                            </div>

                            <!-- Weapon Icon -->
                            <img src="${weaponIcons[char.weapon]}" class="w-4 h-4 brightness-0 dark:invert opacity-80" />
                      </div>
                    </div>
                </div>

                <!-- Role Description -->
                <div class="p-2 text-[10px] text-black/60 dark:text-white/60 bg-[var(--btn-regular-bg)] text-center border-b border-[var(--line-divider)]">
                    This character belongs to the <span class="${getTagColor(char.role)} font-bold">${char.role.toUpperCase()}</span> role.
                </div>

                <!-- Ratings Grid -->
                <div class="grid grid-cols-3 divide-x divide-gray-700 text-center">
                    <div class="p-2 flex flex-col items-center">
                        <div class="${getRankColorClass(char.ranks?.abyss)} w-full py-1 rounded font-bold text-sm mb-1">${char.ranks?.abyss || '-'}</div>
                        <span class="text-[10px] text-black/50 dark:text-white/50">Abyss (C${cons})</span>
                    </div>
                    <div class="p-2 flex flex-col items-center">
                        <div class="${getRankColorClass(char.ranks?.theatre)} w-full py-1 rounded font-bold text-sm mb-1">${char.ranks?.theatre || '-'}</div>
                        <span class="text-[10px] text-black/50 dark:text-white/50">Theatre (C${cons})</span>
                    </div>
                    <div class="p-2 flex flex-col items-center">
                        <div class="${getRankColorClass(char.ranks?.stygian)} w-full py-1 rounded font-bold text-sm mb-1">${char.ranks?.stygian || '-'}</div>
                        <span class="text-[10px] text-black/50 dark:text-white/50">Stygian (C${cons})</span>
                    </div>
                </div>

                <!-- Footer Tags -->
                <div class="p-2 bg-[var(--btn-regular-bg)] rounded-b-lg border-t border-[var(--line-divider)]">
                    <div class="flex flex-wrap justify-center gap-1">
                        <span class="text-[10px] font-bold text-gray-500 uppercase mr-1">TAGS:</span>
                        ${char.tags ? char.tags.map((tag: string) => `<span class="text-[10px] font-bold ${getTagColor(tag)} uppercase">${tag}</span>`).join('<span class="text-gray-600 mx-1">•</span>') : '<span class="text-[10px] text-gray-600">None</span>'}
                    </div>
                </div>
                
                <!-- Little Triangle Arrow at bottom -->
                <div class="absolute left-1/2 -translate-x-1/2 top-full w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-[6px] border-t-[var(--btn-regular-bg)]"></div>
            </div>

          </div>
      `;
  }

function render() {
    if (!container) return;
    container.innerHTML = '';

    // 1. Filter Logic
    const filtered = characters.filter((char: any) => {
      const matchesSearch = char.name.toLowerCase().includes(filters.search.toLowerCase());
      const matchesEl = filters.element === 'all' || char.element === filters.element;
      const matchesWp = filters.weapon === 'all' || char.weapon === filters.weapon;
      const matchesRarity = filters.rarity === 'all' || char.rarity.toString() === filters.rarity;
      return matchesSearch && matchesEl && matchesWp && matchesRarity;
    });

    // 2. Sort into Tiers
    // ensure T1.5 is included here as per previous steps
    const tiers: Record<string, any[]> = { 'T0': [], 'T0.5': [], 'T1': [], 'T1.5': [], 'T2': [], 'T3': [], 'T4': [], 'T5': [] };
    
    filtered.forEach((char: any) => {
      const rank = char.ranks[currentMode] || 'T5';
      if (tiers[rank]) tiers[rank].push(char);
    });

    let hasResults = false;

    // --- NEW: HEADER CONFIGURATION ---
    // Maps specific tiers to a Group Title and Color style
    const groupHeaders: Record<string, { title: string, color: string, border: string }> = {
        'T0':   { title: "THE BEST OF THE BEST", color: "text-red-500", border: "bg-red-500/50" },
        'T0.5': { title: "THE BEST OF THE BEST", color: "text-red-500", border: "bg-red-500/50" },
        
        'T1':   { title: "THE GOOD META OPTIONS", color: "text-orange-500", border: "bg-orange-500/50" },
        'T1.5': { title: "THE GOOD META OPTIONS", color: "text-orange-500", border: "bg-orange-500/50" },
        'T2':   { title: "THE GOOD META OPTIONS", color: "text-orange-500", border: "bg-orange-500/50" },
        
        'T3':   { title: "SITUATIONAL CHARACTERS", color: "text-lime-500", border: "bg-lime-500/50" },
        'T4':   { title: "SITUATIONAL CHARACTERS", color: "text-lime-500", border: "bg-lime-500/50" },
        
        'T5':   { title: "CURRENTLY WEAK CHARACTERS", color: "text-cyan-500", border: "bg-cyan-500/50" }
    };
    
    const renderedGroups = new Set<string>();
    // ----------------------------------

    Object.keys(tiers).forEach(tier => {
      if (tiers[tier].length === 0) return;
      hasResults = true;

      // --- NEW: INJECT HEADER IF NEEDED ---
      const group = groupHeaders[tier];
      if (group && !renderedGroups.has(group.title)) {
          // 1. CHECK: Is this the very first group?
          const isFirstGroup = renderedGroups.size === 0;

          const header = document.createElement('div');
          const marginClass = isFirstGroup ? 'mt-4' : 'mt-0';
          header.className = `flex w-full max-w-7xl mx-auto ${marginClass} mb-2 opacity-90`;
          
          // 2. LOGIC: Only add the Spacer Div if it's the first group
          // If NOT first group, spacerHtml is empty string -> line goes fully left
          const spacerHtml = isFirstGroup 
            ? `<div class="hidden md:flex w-24 shrink-0 items-center justify-center font-black text-white/60 text-xl tracking-widest uppercase select-none">TIER</div>`
            : ``;

          header.innerHTML = `
              ${spacerHtml}
              <div class="flex-grow flex items-center gap-4">
                  <div class="h-[2px] flex-grow ${group.border}"></div>
                  <div class="${group.color} font-black uppercase tracking-widest text-base md:text-lg flex items-center gap-2 whitespace-nowrap">
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6l-6-6z"/></svg>
                      ${group.title}
                      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6l-6-6z"/></svg>
                  </div>
                  <div class="h-[2px] flex-grow ${group.border}"></div>
              </div>
          `;
          
          container.appendChild(header);
          renderedGroups.add(group.title);
      }
      // -------------------------------------
      
      const cols = {
          main: tiers[tier].filter((c: any) => c.role.toLowerCase().includes('main') || c.role === 'DPS'),
          sub: tiers[tier].filter((c: any) => c.role.toLowerCase().includes('sub')),
          support: tiers[tier].filter((c: any) => c.role.toLowerCase().includes('support') || c.role === 'Sustain' || c.role === 'Amplifier')
      };

      const row = document.createElement('div');
      // Added !overflow-visible to ensure tooltips don't get clipped
      row.className = 'card-base flex flex-col md:flex-row !overflow-visible mb-3 shadow-md'; 
      const labelColorClass = tierColors[tier] || tierColors['T5'];
      
      // ... (Rest of your row.innerHTML logic stays exactly the same) ...
      row.innerHTML = `
        <div class="w-full md:w-24 ${labelColorClass} font-bold text-2xl flex items-center justify-center p-4 border-b md:border-b-0 md:border-r border-[var(--line-divider)] border-dashed shrink-0">
          ${tier}
        </div>
        <div class="flex-grow grid grid-cols-1 md:grid-cols-3 divide-y md:divide-y-0 md:divide-x divide-[var(--line-divider)] border-dashed bg-[var(--card-bg)]">
          <div class="p-3 flex flex-wrap gap-x-3 gap-y-6 content-start relative min-h-[100px]">
              <div class="md:hidden text-xs font-bold text-red-400 w-full mb-2 opacity-75">MAIN DPS</div>
              ${cols.main.map((c: any) => createCharCard(c)).join('')}
          </div>
          <div class="p-3 flex flex-wrap gap-x-3 gap-y-6 content-start relative min-h-[100px]">
              <div class="md:hidden text-xs font-bold text-purple-400 w-full mb-2 opacity-75">SUB DPS</div>
              ${cols.sub.map((c: any) => createCharCard(c)).join('')}
          </div>
          <div class="p-3 flex flex-wrap gap-x-3 gap-y-6 content-start relative min-h-[100px]">
               <div class="md:hidden text-xs font-bold text-emerald-400 w-full mb-2 opacity-75">SUPPORT</div>
               ${cols.support.map((c: any) => createCharCard(c)).join('')}
          </div>
        </div>
      `;
      container.appendChild(row);
    });

    if (!hasResults) {
      container.innerHTML = `<div class="card-base p-8 text-center text-50 italic">No characters found matching criteria.</div>`;
    }
    if (searchInput && searchInput.parentElement) {
      searchInput.parentElement.classList.toggle('has-value', filters.search.length > 0);
    }
  }

  // --- EVENT LISTENERS ---
  modeBtns.forEach(btn => {
    btn.addEventListener('click', (e) => {
      modeBtns.forEach(b => b.classList.remove('active'));
      const target = e.currentTarget as HTMLElement;
      target.classList.add('active');
      if (target.dataset.mode) currentMode = target.dataset.mode;
      render();
    });
  });

  filterBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
          const target = e.currentTarget as HTMLElement;
          const groupEl = target.closest('.filter-group') as HTMLElement;
          if(!groupEl || !groupEl.dataset.group || !target.dataset.value) return;

          const group = groupEl.dataset.group;
          const value = target.dataset.value;
          filters[group] = value;
          setActiveFilterBtns();
          render();
      });
  });

  if (searchInput) {
      searchInput.addEventListener('input', (e) => { 
          const target = e.target as HTMLInputElement;
          filters.search = target.value; 
          render(); 
      });
  }
  
  if (clearSearchBtn) {
      clearSearchBtn.addEventListener('click', () => {
          filters.search = '';
          if (searchInput) {
              searchInput.value = '';
              searchInput.focus();
          }
          render();
      });
  }

  if (resetBtn) {
      resetBtn.addEventListener('click', () => {
          filters = { element: 'all', weapon: 'all', rarity: 'all', search: '' };
          if (searchInput) searchInput.value = '';
          setActiveFilterBtns();
          render();
      });
  }

  function setActiveFilterBtns() {
      filterBtns.forEach(btn => {
          const target = btn as HTMLElement;
          const groupEl = target.closest('.filter-group') as HTMLElement;
          if(!groupEl || !groupEl.dataset.group) return;

          const group = groupEl.dataset.group;
          target.dataset.active = filters[group] === target.dataset.value ? 'true' : 'false';
          
          if(group === 'rarity') {
              if(target.dataset.active === 'true') {
                  target.classList.remove('text-blue-400', 'text-purple-400', 'text-yellow-400');
                  target.classList.add('text-white');
              } else {
                  const val = target.dataset.value;
                  target.classList.remove('text-white');
                  if(val === 'all') target.classList.add('text-blue-400');
                  if(val === '4') target.classList.add('text-purple-400');
                  if(val === '5') target.classList.add('text-yellow-400');
              }
          }
      });
  }

  function init() {
    document.querySelector('[data-mode="abyss"]')?.classList.add('active');
    setActiveFilterBtns();
    render();
  }

  init();
</script>

<style>
  .filter-btn[data-active="true"] {
      background-color: var(--primary);
      color: white;
  }
  .filter-btn[data-active="true"] svg path {
      fill: currentColor;
  }
  .filter-btn[data-active="true"] img {
      filter: brightness(0) invert(1);
  }
  .group.has-value #clearSearch {
      opacity: 1;
  }
</style>

</MainGridLayout>