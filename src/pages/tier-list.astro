---
import { tierListInfo } from "../data/tierListInfo";
import { characters } from "../data/tierlist";
import MainGridLayout from "../layouts/MainGridLayout.astro";

// --- DATA & ICONS ---
const icons = {
	pyro: "/assets/icons/pyro.png",
	hydro: "/assets/icons/hydro.png",
	anemo: "/assets/icons/anemo.png",
	electro: "/assets/icons/electro.png",
	dendro: "/assets/icons/dendro.png",
	cryo: "/assets/icons/cryo.png",
	geo: "/assets/icons/geo.png",
	sword: "/assets/icons/sword.png",
	claymore: "/assets/icons/claymore.png",
	polearm: "/assets/icons/polearm.png",
	catalyst: "/assets/icons/catalyst.png",
	bow: "/assets/icons/bow.png",
	wildcard: "/assets/icons/star.png",
	rarity4: "/assets/icons/4star.png",
	rarity5: "/assets/icons/5star.png",
	close: "/assets/icons/close.png",
};

const filterData = {
	rarity: [
		{ id: "all", label: "∗", color: "text-blue-400" },
		{ id: "4", label: "4★", color: "text-purple-400" },
		{ id: "5", label: "5★", color: "text-yellow-400" },
	],
	elements: [
		{ id: "all" },
		{ id: "pyro", icon: icons.pyro },
		{ id: "hydro", icon: icons.hydro },
		{ id: "anemo", icon: icons.anemo },
		{ id: "electro", icon: icons.electro },
		{ id: "dendro", icon: icons.dendro },
		{ id: "cryo", icon: icons.cryo },
		{ id: "geo", icon: icons.geo },
	],
	weapons: [
		{ id: "all" },
		{ id: "sword", icon: icons.sword },
		{ id: "claymore", icon: icons.claymore },
		{ id: "polearm", icon: icons.polearm },
		{ id: "catalyst", icon: icons.catalyst },
		{ id: "bow", icon: icons.bow },
	],
};

const tierColors = {
	T0: "border-red-500/50 bg-red-500/10 text-red-500",
	"T0.5": "border-orange-500/50 bg-orange-500/10 text-orange-500",
	T1: "border-yellow-500/50 bg-yellow-500/10 text-yellow-500",
	T2: "border-green-500/50 bg-green-500/10 text-green-500",
	T3: "border-blue-500/50 bg-blue-500/10 text-blue-500",
	T4: "border-gray-500/50 bg-gray-500/10 text-gray-500",
};
---

<MainGridLayout title="Tier List">
  
<!-- HEADER INFO -->
<div class="max-w-7xl mx-auto mb-6">
  <div class="card-base p-6 mb-4 flex flex-col items-center text-center">
      <h1 class="text-3xl md:text-4xl font-bold text-90 mb-2">Xiffy's Tier List</h1>
      <div class="flex items-center gap-2 text-50 text-sm">
          <span>Patch: 5.2</span><span class="w-1 h-1 bg-current rounded-full"></span><span>Updated: Today</span>
      </div>
  </div>
  <div class="card-base flex flex-col">
    {tierListInfo.map((item) => (
      <details class="group border-b border-[var(--line-divider)] border-dashed last:border-none">
        <summary class="flex justify-between items-center p-4 font-medium text-75 hover:text-[var(--primary)] hover:bg-[var(--btn-plain-bg-hover)] transition select-none list-none cursor-pointer">
          {item.title}
          <span class="transform group-open:rotate-180 transition-transform duration-200 text-50">
             <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6l-6-6z"/></svg>
          </span>
        </summary>
        <div class="px-4 pb-4 text-sm text-50 pt-2" set:html={item.content} />
      </details>
    ))}
  </div>
</div>

<!-- MODE SWITCHER -->
<div class="max-w-7xl mx-auto grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
  {['overworld', 'abyss', 'theatre', 'stygian'].map((mode) => (
    <button class="mode-btn relative p-3 card-base hover:bg-[var(--btn-card-bg-hover)] group transition-all border border-transparent" data-mode={mode}>
      <div class="text-xs uppercase tracking-wider text-50 mb-1">Game Mode</div>
      <div class="text-lg font-bold capitalize text-75 group-[.active]:text-[var(--primary)]">{mode}</div>
      <div class="active-indicator absolute bottom-0 left-0 w-full h-0.5 bg-[var(--primary)] scale-x-0 group-[.active]:scale-x-100 transition-transform duration-300 origin-left"></div>
    </button>
  ))}
</div>

<!-- FILTER TOOLBAR -->
<div class="max-w-7xl mx-auto mb-6 sticky top-[4.5rem] z-20">
  <div class="card-base p-1.5 flex flex-nowrap items-center gap-1.5 bg-[var(--card-bg)] shadow-lg border border-[var(--line-divider)] overflow-x-auto hide-scrollbar">
      <div class="relative min-w-[140px] w-40 md:w-40 mx-1.5 group shrink-0">
          <input type="text" id="searchInput" placeholder="Search..." class="w-full bg-[var(--btn-regular-bg)] text-90 rounded-md pl-4 pr-8 py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-[var(--primary)] transition placeholder:text-50" />
          <button id="clearSearch" class="absolute right-2 top-1/2 -translate-y-1/2 text-50 hover:text-90 opacity-0 group-focus-within:opacity-100 has-value:opacity-100 transition">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
          </button>
      </div>
      <div class="h-5 w-px bg-[var(--line-divider)] hidden md:block shrink-0"></div>
      <div class="flex flex-nowrap gap-1.5 items-center">
          <div class="filter-group flex bg-[var(--btn-regular-bg)] rounded-md p-0.5 shrink-0" data-group="rarity">
              {filterData.rarity.map(item => (
                  <button class={`filter-btn relative px-3 py-1 rounded-sm text-sm font-bold transition hover:bg-[var(--btn-plain-bg-hover)] [data-active=true]:bg-[var(--primary)] [data-active=true]:text-white flex items-center justify-center ${item.color}`} 
                          data-value={item.id} 
                          title={item.id === 'all' ? 'All Rarities' : item.id + ' Star'}>
                      <span class={item.id === 'all' ? 'text-xl leading-none font-bold' : ''}>{item.label}</span>
                  </button>
              ))}
          </div>
          <div class="filter-group flex bg-[var(--btn-regular-bg)] rounded-md p-0.5 shrink-0" data-group="element">
              {filterData.elements.map(item => (
                  <button class="filter-btn w-8 h-8 rounded-sm text-50 hover:text-90 hover:bg-[var(--btn-plain-bg-hover)] transition [data-active=true]:bg-[var(--primary)] [data-active=true]:text-white flex items-center justify-center" data-value={item.id} title={item.id}>
                      {item.id === 'all' ? <span class="text-xl font-bold leading-none">∗</span> : <img src={item.icon} alt={item.id} class="w-5 h-5 object-contain" />}
                  </button>
              ))}
          </div>
          <div class="filter-group flex bg-[var(--btn-regular-bg)] rounded-md p-0.5 shrink-0" data-group="weapon">
              {filterData.weapons.map(item => (
                  <button class="filter-btn w-8 h-8 rounded-sm text-50 hover:text-90 hover:bg-[var(--btn-plain-bg-hover)] transition [data-active=true]:bg-[var(--primary)] [data-active=true]:text-white flex items-center justify-center" data-value={item.id} title={item.id}>
                      {item.id === 'all' ? <span class="text-xl font-bold leading-none">∗</span> : <img src={item.icon} alt={item.id} class="w-5 h-5 object-contain" />}
                  </button>
              ))}
          </div>
      </div>
      <button id="resetFilters" class="px-3 py-2 rounded-md text-sm font-medium text-50 hover:text-red-400 hover:bg-[var(--btn-regular-bg-hover)] transition flex items-center gap-1.5 ml-auto shrink-0 border-l border-[var(--line-divider)] md:border-none pl-3 md:pl-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> 
          <span class="hidden md:inline">Reset</span>
      </button>
  </div>
</div>

<!-- TABLE HEADER -->
<div class="max-w-7xl mx-auto hidden md:grid grid-cols-[6rem_1fr_1fr_1fr] gap-0 px-0 mb-2">
   <div></div>
   <div class="bg-[var(--card-bg)]/50 py-2 text-center border-b-2 border-red-500/50 flex items-center justify-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10s10-4.48 10-10S17.52 2 12 2zm-1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
      <span class="font-bold text-red-400 text-sm tracking-wider">MAIN DPS</span>
   </div>
   <div class="bg-[var(--card-bg)]/50 py-2 text-center border-b-2 border-purple-500/50 flex items-center justify-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M11 9h2V7h-2m0 10h2v-6h-2m-9 2h2v-2H2v-2h2V9H2V7h2V5h2v2h2v2H6v2h2v2H6v2H2v-2"/></svg>
      <span class="font-bold text-purple-400 text-sm tracking-wider">SUB DPS</span>
   </div>
   <div class="bg-[var(--card-bg)]/50 py-2 text-center border-b-2 border-emerald-500/50 flex items-center justify-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M9 21h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2c0-1.1-.9-2-2-2h-6.31l.95-4.57l.03-.32c0-.41-.17-.79-.44-1.06L14.17 1L7.58 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2M9 9l4.34-4.34L12 10h9v2l-3 7H9V9M1 9h4v12H1V9z"/></svg>
      <span class="font-bold text-emerald-400 text-sm tracking-wider">SUPPORT</span>
   </div>
</div>

<!-- HIDDEN DATA BRIDGE -->
<div id="tierListData" 
     data-characters={JSON.stringify(characters)} 
     data-colors={JSON.stringify(tierColors)} 
     class="hidden">
</div>

<!-- TIER LIST CONTAINER -->
<div id="tierListContainer" class="max-w-7xl mx-auto flex flex-col gap-3 min-h-[50vh]"></div>
<script>
  const dataEl = document.getElementById('tierListData');
  // Using simple checks for safety without '!' because this is strict TS
  if (!dataEl) throw new Error("Tier List Data Missing");

  const characters = JSON.parse(dataEl.dataset.characters || '[]');
  const tierColors = JSON.parse(dataEl.dataset.colors || '{}');

  // --- STATE ---
  let currentMode = 'abyss';
  // Explicitly typing this as 'any' helps avoid index errors in strict mode for dynamic keys
  let filters: any = { element: 'all', weapon: 'all', rarity: 'all', search: '' };

  // --- DOM ---
  const container = document.getElementById('tierListContainer');
  const modeBtns = document.querySelectorAll('.mode-btn');
  const searchInput = document.getElementById('searchInput') as HTMLInputElement;
  const clearSearchBtn = document.getElementById('clearSearch');
  const filterBtns = document.querySelectorAll('.filter-btn');
  const resetBtn = document.getElementById('resetFilters');

  // --- HELPERS ---
  // Defined as Record<string, string> so TS knows any string key is valid
  const elementIcons: Record<string, string> = {
      'pyro': '/assets/icons/pyro.png',
      'hydro': '/assets/icons/hydro.png',
      'anemo': '/assets/icons/anemo.png',
      'electro': '/assets/icons/electro.png',
      'dendro': '/assets/icons/dendro.png',
      'cryo': '/assets/icons/cryo.png',
      'geo': '/assets/icons/geo.png'
  };
  
  const weaponIcons: Record<string, string> = {
      'sword': '/assets/icons/sword.png',
      'claymore': '/assets/icons/claymore.png',
      'polearm': '/assets/icons/polearm.png',
      'catalyst': '/assets/icons/catalyst.png',
      'bow': '/assets/icons/bow.png'
  };

  function getTagColor(tag: string) {
      const t = tag.toUpperCase();
      if (t.includes('DPS') || t.includes('PARTNER') || t.includes('CARRY')) return 'text-red-400';
      if (t.includes('BUFF') || t.includes('ADVANCE') || t.includes('SP-FRIENDLY') || t.includes('HEALER')) return 'text-emerald-400';
      if (t.includes('DEBUFF') || t.includes('DOT') || t.includes('BREAK')) return 'text-blue-300';
      if (t.includes('SHIELD') || t.includes('SUSTAIN')) return 'text-yellow-400';
      return 'text-gray-300';
  }

  function getRankColorClass(rank: string) {
      if (!rank) return 'bg-gray-700';
      if (rank === 'T0') return 'bg-red-500 text-white';
      if (rank === 'T0.5') return 'bg-orange-500 text-white';
      if (rank === 'T1') return 'bg-yellow-500 text-black';
      if (rank === 'T1.5') return 'bg-yellow-400/80 text-black';
      if (rank === 'T2') return 'bg-green-500 text-white';
      if (rank === 'T3') return 'bg-blue-500 text-white';
      if (rank === 'T4') return 'bg-gray-500 text-white';
      return 'bg-gray-700 text-gray-300';
  }

  // --- CARD CREATION WITH PRYDWEN HOVER ---
  // Using char: any to bypass strict type checks on dynamic data object
  function createCharCard(char: any) {
      const cons = char.constellation !== undefined ? char.constellation : (char.rarity === 5 ? 0 : 6);
      let bgImage = '/assets/backgrounds/4star-bg.png';
      if (char.id === 'aloy') bgImage = '/assets/backgrounds/aloy-bg.png';
      else if (char.rarity === 5) bgImage = '/assets/backgrounds/5star-bg.png';

      return `
          <div class="relative group w-[80px] flex flex-col items-center z-0 hover:z-50">
            
            <!-- CARD -->
            <div class="relative w-[80px] h-[80px] rounded-md overflow-hidden shadow-md mb-1 bg-cover bg-center cursor-pointer" 
                 style="background-image: url('${bgImage}');"
                 title="${char.name}">
                <img src="${char.image}" class="w-full h-full object-cover p-[1px]" alt="${char.name}" onerror="this.style.opacity='0.2'"/>
                <div class="absolute top-0.5 left-0.5 w-5 h-5 bg-black/50 rounded-full p-0.5 backdrop-blur-sm z-10">
                    <img src="${elementIcons[char.element]}" class="w-full h-full object-contain" />
                </div>
                <div class="absolute top-0 right-0 bg-[#eab308] text-black text-[9px] font-bold px-1 py-0.5 rounded-bl-md leading-none shadow-sm z-10">C${cons}</div>
                <div class="absolute bottom-0 left-0 w-full pt-5 pb-1 px-0.5 bg-gradient-to-t from-black/90 via-black/50 to-transparent z-20 flex items-end justify-center">
                    <span class="text-[9px] text-white font-bold text-center leading-none truncate w-full drop-shadow-md">${char.name}</span>
                </div>
            </div>

            <!-- PRYDWEN HOVER POPUP -->
            <div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-64 bg-[var(--card-bg)] border border-[var(--line-divider)] border-gray-700 rounded-lg shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 pointer-events-none z-50">
                
                <!-- Header: Name & Basic Info -->
                <div class="p-3 border-b border-gray-700 flex gap-3">
                    <!-- Rarity Background Wrapper -->
                  <div class="w-12 h-12 rounded-md overflow-hidden bg-cover bg-center shrink-0 border border-white/10" style="background-image: url('${bgImage}');">
                      <img src="${char.image}" class="w-full h-full object-cover" />
                  </div>
                    <div class="flex flex-col justify-center">
                        <div class="text-[var(--primary)] font-bold text-lg leading-tight text-left">${char.name}</div>
                        <div class="flex items-center gap-2 mt-1">
                            <!-- Rarity Badge -->
                            <span class="text-xs px-1.5 py-0.5 rounded bg-gray-700 text-yellow-400 font-bold shadow-sm">${char.rarity}★</span>
                            
                            <!-- Element Icon (New Gradient Background) -->
                            <div class="w-5 h-5 rounded-full flex items-center justify-center bg-gradient-to-br from-black/60 to-black/30 shadow-sm border border-white/10">
                                <img src="${elementIcons[char.element]}" class="w-3.5 h-3.5 object-contain" />
                            </div>

                            <!-- Weapon Icon -->
                            <img src="${weaponIcons[char.weapon]}" class="w-4 h-4 brightness-0 dark:invert opacity-80" />
                      </div>
                    </div>
                </div>

                <!-- Role Description -->
                <div class="p-2 text-[10px] text-black/60 dark:text-white/60 bg-[var(--btn-regular-bg)] text-center border-b border-[var(--line-divider)]">
                    This character belongs to the <span class="${getTagColor(char.role)} font-bold">${char.role.toUpperCase()}</span> role.
                </div>

                <!-- Ratings Grid -->
                <div class="grid grid-cols-3 divide-x divide-gray-700 text-center">
                    <div class="p-2 flex flex-col items-center">
                        <div class="${getRankColorClass(char.ranks?.abyss)} w-full py-1 rounded font-bold text-sm mb-1">${char.ranks?.abyss || '-'}</div>
                        <span class="text-[10px] text-black/50 dark:text-white/50">Abyss (C${cons})</span>
                    </div>
                    <div class="p-2 flex flex-col items-center">
                        <div class="${getRankColorClass(char.ranks?.theatre)} w-full py-1 rounded font-bold text-sm mb-1">${char.ranks?.theatre || '-'}</div>
                        <span class="text-[10px] text-black/50 dark:text-white/50">Theatre (C${cons})</span>
                    </div>
                    <div class="p-2 flex flex-col items-center">
                        <div class="${getRankColorClass(char.ranks?.stygian)} w-full py-1 rounded font-bold text-sm mb-1">${char.ranks?.stygian || '-'}</div>
                        <span class="text-[10px] text-black/50 dark:text-white/50">Stygian (C${cons})</span>
                    </div>
                </div>

                <!-- Footer Tags -->
                <div class="p-2 bg-[var(--btn-regular-bg)] rounded-b-lg border-t border-[var(--line-divider)]">
                    <div class="flex flex-wrap justify-center gap-1">
                        <span class="text-[10px] font-bold text-gray-500 uppercase mr-1">TAGS:</span>
                        ${char.tags ? char.tags.map((tag: string) => `<span class="text-[10px] font-bold ${getTagColor(tag)}">${tag}</span>`).join('<span class="text-gray-600 mx-1">•</span>') : '<span class="text-[10px] text-gray-600">None</span>'}
                    </div>
                </div>
                
                <!-- Little Triangle Arrow at bottom -->
                <div class="absolute left-1/2 -translate-x-1/2 top-full w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-[6px] border-t-[var(--btn-regular-bg)]"></div>
            </div>

          </div>
      `;
  }

  function render() {
    if (!container) return;
    container.innerHTML = '';
    
    const filtered = characters.filter((char: any) => {
      const matchesSearch = char.name.toLowerCase().includes(filters.search.toLowerCase());
      const matchesEl = filters.element === 'all' || char.element === filters.element;
      const matchesWp = filters.weapon === 'all' || char.weapon === filters.weapon;
      const matchesRarity = filters.rarity === 'all' || char.rarity.toString() === filters.rarity;
      return matchesSearch && matchesEl && matchesWp && matchesRarity;
    });

    // Type the tiers object safely
    const tiers: Record<string, any[]> = { 'T0': [], 'T0.5': [], 'T1': [], 'T2': [], 'T3': [], 'T4': [] };
    filtered.forEach((char: any) => {
      const rank = char.ranks[currentMode] || 'T4';
      if (tiers[rank]) tiers[rank].push(char);
    });

    let hasResults = false;
    Object.keys(tiers).forEach(tier => {
      if (tiers[tier].length === 0) return;
      hasResults = true;
      
      const cols = {
          main: tiers[tier].filter((c: any) => c.role.toLowerCase().includes('main') || c.role === 'DPS'),
          sub: tiers[tier].filter((c: any) => c.role.toLowerCase().includes('sub')),
          support: tiers[tier].filter((c: any) => c.role.toLowerCase().includes('support') || c.role === 'Sustain' || c.role === 'Amplifier')
      };

      const row = document.createElement('div');
      // CRITICAL FIX: Overflow MUST be visible for tooltip to show up
      row.className = 'card-base flex flex-col md:flex-row !overflow-visible mb-3'; 
      const labelColorClass = tierColors[tier] || tierColors['T4'];
      
      row.innerHTML = `
        <div class="w-full md:w-24 ${labelColorClass} font-bold text-2xl flex items-center justify-center p-4 border-b md:border-b-0 md:border-r border-[var(--line-divider)] border-dashed shrink-0">
          ${tier}
        </div>
        <div class="flex-grow grid grid-cols-1 md:grid-cols-3 divide-y md:divide-y-0 md:divide-x divide-[var(--line-divider)] border-dashed bg-[var(--card-bg)]">
          <div class="p-3 flex flex-wrap gap-x-3 gap-y-6 content-start relative min-h-[100px]">
              <div class="md:hidden text-xs font-bold text-red-400 w-full mb-2 opacity-75">MAIN DPS</div>
              ${cols.main.map((c: any) => createCharCard(c)).join('')}
          </div>
          <div class="p-3 flex flex-wrap gap-x-3 gap-y-6 content-start relative min-h-[100px]">
              <div class="md:hidden text-xs font-bold text-purple-400 w-full mb-2 opacity-75">SUB DPS</div>
              ${cols.sub.map((c: any) => createCharCard(c)).join('')}
          </div>
          <div class="p-3 flex flex-wrap gap-x-3 gap-y-6 content-start relative min-h-[100px]">
               <div class="md:hidden text-xs font-bold text-emerald-400 w-full mb-2 opacity-75">SUPPORT</div>
              ${cols.support.map((c: any) => createCharCard(c)).join('')}
          </div>
        </div>
      `;
      container.appendChild(row);
    });

    if (!hasResults) {
      container.innerHTML = `<div class="card-base p-8 text-center text-50 italic">No characters found matching criteria.</div>`;
    }
    if (searchInput && searchInput.parentElement) {
      searchInput.parentElement.classList.toggle('has-value', filters.search.length > 0);
    }
  }

  // --- EVENT LISTENERS ---
  modeBtns.forEach(btn => {
    btn.addEventListener('click', (e) => {
      modeBtns.forEach(b => b.classList.remove('active'));
      const target = e.currentTarget as HTMLElement;
      target.classList.add('active');
      if (target.dataset.mode) currentMode = target.dataset.mode;
      render();
    });
  });

  filterBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
          const target = e.currentTarget as HTMLElement;
          const groupEl = target.closest('.filter-group') as HTMLElement;
          if(!groupEl || !groupEl.dataset.group || !target.dataset.value) return;

          const group = groupEl.dataset.group;
          const value = target.dataset.value;
          filters[group] = value;
          setActiveFilterBtns();
          render();
      });
  });

  if (searchInput) {
      searchInput.addEventListener('input', (e) => { 
          const target = e.target as HTMLInputElement;
          filters.search = target.value; 
          render(); 
      });
  }
  
  if (clearSearchBtn) {
      clearSearchBtn.addEventListener('click', () => {
          filters.search = '';
          if (searchInput) {
              searchInput.value = '';
              searchInput.focus();
          }
          render();
      });
  }

  if (resetBtn) {
      resetBtn.addEventListener('click', () => {
          filters = { element: 'all', weapon: 'all', rarity: 'all', search: '' };
          if (searchInput) searchInput.value = '';
          setActiveFilterBtns();
          render();
      });
  }

  function setActiveFilterBtns() {
      filterBtns.forEach(btn => {
          const target = btn as HTMLElement;
          const groupEl = target.closest('.filter-group') as HTMLElement;
          if(!groupEl || !groupEl.dataset.group) return;

          const group = groupEl.dataset.group;
          target.dataset.active = filters[group] === target.dataset.value ? 'true' : 'false';
          
          if(group === 'rarity') {
              if(target.dataset.active === 'true') {
                  target.classList.remove('text-blue-400', 'text-purple-400', 'text-yellow-400');
                  target.classList.add('text-white');
              } else {
                  const val = target.dataset.value;
                  target.classList.remove('text-white');
                  if(val === 'all') target.classList.add('text-blue-400');
                  if(val === '4') target.classList.add('text-purple-400');
                  if(val === '5') target.classList.add('text-yellow-400');
              }
          }
      });
  }

  function init() {
    document.querySelector('[data-mode="abyss"]')?.classList.add('active');
    setActiveFilterBtns();
    render();
  }

  init();
</script>

<style>
  .filter-btn[data-active="true"] {
      background-color: var(--primary);
      color: white;
  }
  .filter-btn[data-active="true"] svg path {
      fill: currentColor;
  }
  .filter-btn[data-active="true"] img {
      filter: brightness(0) invert(1);
  }
  .group.has-value #clearSearch {
      opacity: 1;
  }
</style>

</MainGridLayout>